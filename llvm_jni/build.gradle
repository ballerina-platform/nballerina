/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/7.1/samples
 */
plugins{
        id 'java-gradle-plugin'
}

repositories {
        mavenCentral()
}

dependencies {
        implementation 'org.bytedeco:llvm-platform:11.1.0-1.5.5'
}

String platformLibs = 'target/platform-libs'
String tmpBuildDir = '../testbuild'
String compilerDir = '../compiler'
String testDir = '../test'

configurations.implementation.setCanBeResolved(true) 
configurations.api.setCanBeResolved(true)
task copyDependencies(type: Copy) {
        from configurations.implementation
        into platformLibs
}

task copyNbal(type: Copy) {
        from compilerDir
        into tmpBuildDir
        filter { line -> line.replaceAll('print.llvm', 'jni.llvm') }
}

task cleanNbackLLVM(type: Delete) {
        delete "${tmpBuildDir}/modules/print.llvm"
}
cleanNbackLLVM.dependsOn(copyNbal)

task copyJNILLVM(type: Copy) {
        from 'modules/jni.llvm'
        into "${tmpBuildDir}/modules/jni.llvm"
}
copyJNILLVM.dependsOn(copyNbal, cleanNbackLLVM)

task copyLocalDependencies(type: Copy) {
        from platformLibs
        into "${tmpBuildDir}/target/platform-libs"
}
copyLocalDependencies.dependsOn(copyDependencies);

task copyBalConfig(type: Copy) {
        from 'Ballerina.toml'
        into tmpBuildDir
}
copyBalConfig.dependsOn(copyLocalDependencies, copyNbal)

task testBuild(type: Exec) {
        workingDir tmpBuildDir
        commandLine 'bal', 'build'
}
testBuild.dependsOn(copyNbal, copyJNILLVM, copyLocalDependencies, copyBalConfig)

task buildNBalCompilerBase(type: Exec) {
        workingDir compilerDir
        commandLine 'bal', 'build', '--skip-tests'
}

task compileExpectedTestCases(type: Exec) {
        workingDir testDir
        commandLine './compile.sh'
}
compileExpectedTestCases.dependsOn(buildNBalCompilerBase)

task normalizeExpectedTestCases(type: Exec) {
        workingDir testDir
        commandLine './normalize.sh'
}
normalizeExpectedTestCases.dependsOn(compileExpectedTestCases)

task copyCompatibility_test(type: Copy) {
        from 'compatibility_test'
        into tmpBuildDir
}
copyCompatibility_test.dependsOn(testBuild)

task compileActualTestCases(type: Exec) {
        workingDir "${tmpBuildDir}/compatibility_test"
        commandLine './compile-jni.sh'
}
compileActualTestCases.dependsOn(copyCompatibility_test)

task normalizeActualTestCases(type: Exec) {
        workingDir "${tmpBuildDir}/compatibility_test"
        commandLine './normalize.sh'
}
normalizeActualTestCases.dependsOn(compileActualTestCases)

task compareTestCases(type: Exec) {
        workingDir "${tmpBuildDir}/compatibility_test"
        commandLine './compare.sh'
}
compareTestCases.dependsOn(normalizeActualTestCases)

task cleanTestBuild(type: Delete) {
        delete tmpBuildDir
}
