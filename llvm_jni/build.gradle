/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/7.1/samples
 */
plugins{
        id 'java-gradle-plugin'
}

repositories {
        mavenCentral()
}

dependencies {
        implementation 'org.bytedeco:llvm-platform:11.1.0-1.5.5'
}

String platformLibs = 'target/platform-libs'
String tmpBuildDir = '../testbuild'
String compilerDir = '../compiler'

configurations.implementation.setCanBeResolved(true) 
configurations.api.setCanBeResolved(true)
task copyDependencies(type: Copy) {
        from configurations.implementation
        into platformLibs
}

task copyNbal(type: Copy) {
        from compilerDir
        into tmpBuildDir
        filter { line -> line.replaceAll('print.llvm', 'jni.llvm') }
}

task cleanNbackLLVM(type: Delete) {
        delete "${tmpBuildDir}/modules/print.llvm"
}
cleanNbackLLVM.dependsOn(copyNbal)

task copyJNILLVM(type: Copy) {
        from 'modules/jni.llvm'
        into "${tmpBuildDir}/modules/jni.llvm"
}
copyJNILLVM.dependsOn(copyNbal, cleanNbackLLVM)

task copyLocalDependencies(type: Copy) {
        from platformLibs
        into "${tmpBuildDir}/target/platform-libs"
}

task copyBalConfig(type: Copy) {
        from 'Ballerina.toml'
        into tmpBuildDir
}
copyBalConfig.dependsOn(copyLocalDependencies, copyNbal)

task testBuild(type: Exec) {
        workingDir tmpBuildDir
        commandLine 'bal', 'build'
}
testBuild.dependsOn(copyNbal, copyJNILLVM, copyLocalDependencies, copyBalConfig)

task cleanTestBuild(type: Delete) {
        delete tmpBuildDir
}
